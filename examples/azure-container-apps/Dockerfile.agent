# Agent server Dockerfile
# AutoGen agent with py-code-mode integration

FROM python:3.12-slim

WORKDIR /app

# Install uv for fast package management
RUN pip install uv

# Copy py-code-mode source (for integrations module)
COPY pyproject.toml README.md ./
COPY src/ src/

# Install py-code-mode with redis support
RUN uv pip install --system -e ".[redis]"

# Copy example dependencies and agent code
COPY examples/azure-container-apps/pyproject.toml ./example-pyproject.toml
COPY examples/azure-container-apps/agent_server.py ./

# Install agent dependencies (autogen, azure-identity, etc.)
RUN uv pip install --system \
    "autogen-agentchat>=0.4" \
    "autogen-ext[openai]>=0.4" \
    "azure-identity>=1.15.0" \
    "fastapi>=0.115.0" \
    "uvicorn>=0.32.0" \
    "httpx>=0.27.0" \
    "tiktoken>=0.12.0" \
    "aiohttp>=3.9.0"

# Environment
ENV PYTHONUNBUFFERED=1
ENV HOST=0.0.0.0
ENV PORT=8080

EXPOSE 8080

CMD ["python", "-m", "uvicorn", "agent_server:app", "--host", "0.0.0.0", "--port", "8080"]
